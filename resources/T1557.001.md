# T1557.001: LLMNR/NBT-NS Poisoning and SMB Relay
**MITRE ATT&CK Tactic(s):** Credential Access, Collection

**[MITRE ATT&CK Description](https://attack.mitre.org/techniques/T1557/001)**
<blockquote>By responding to LLMNR/NBT-NS network traffic, adversaries may spoof an authoritative source for name resolution to force communication with an adversary controlled system. This activity may be used to collect or relay authentication materials. 

Link-Local Multicast Name Resolution (LLMNR) and NetBIOS Name Service (NBT-NS) are Microsoft Windows components that serve as alternate methods of host identification. LLMNR is based upon the Domain Name System (DNS) format and allows hosts on the same local link to perform name resolution for other hosts. NBT-NS identifies systems on a local network by their NetBIOS name. (Citation: Wikipedia LLMNR) (Citation: TechNet NetBIOS)

Adversaries can spoof an authoritative source for name resolution on a victim network by responding to LLMNR (UDP 5355)/NBT-NS (UDP 137) traffic as if they know the identity of the requested host, effectively poisoning the service so that the victims will communicate with the adversary controlled system. If the requested host belongs to a resource that requires identification/authentication, the username and NTLMv2 hash will then be sent to the adversary controlled system. The adversary can then collect the hash information sent over the wire through tools that monitor the ports for traffic or through [Network Sniffing](https://attack.mitre.org/techniques/T1040) and crack the hashes offline through [Brute Force](https://attack.mitre.org/techniques/T1110) to obtain the plaintext passwords. In some cases where an adversary has access to a system that is in the authentication path between systems or when automated scans that use credentials attempt to authenticate to an adversary controlled system, the NTLMv2 hashes can be intercepted and relayed to access and execute code against a target system. The relay step can happen in conjunction with poisoning but may also be independent of it. (Citation: byt3bl33d3r NTLM Relaying)(Citation: Secure Ideas SMB Relay)

Several tools exist that can be used to poison name services within local networks such as NBNSpoof, Metasploit, and [Responder](https://attack.mitre.org/software/S0174). (Citation: GitHub NBNSpoof) (Citation: Rapid7 LLMNR Spoofer) (Citation: GitHub Responder)</blockquote>

## Policy / Process Controls
### [MITRE D3FEND](https://d3fend.mitre.org/)
**Last accessed:** April 27, 2022

**Total ATT&CK-mapped resources:** 2328

**ATT&CK-mapped resources for this (sub)technique:** 9

Resources mapped to this (sub)technique can be viewed on [this page](https://d3fend.mitre.org/) (see also the [ATT&CK to D3FEND Mapper](https://d3fend.mitre.org/tools/attack-mapper) tool):

* [Per Host Download-Upload Ratio Analysis](https://d3fend.mitre.org/techniques/d3f:PerHostDownload-UploadRatioAnalysis)
* [Protocol Metadata Anomaly Detection](https://d3fend.mitre.org/techniques/d3f:ProtocolMetadataAnomalyDetection)
* [Remote Terminal Session Detection](https://d3fend.mitre.org/techniques/d3f:RemoteTerminalSessionDetection)
* [Connection Attempt Analysis](https://d3fend.mitre.org/techniques/d3f:ConnectionAttemptAnalysis)
* [Network Traffic Community Deviation](https://d3fend.mitre.org/techniques/d3f:NetworkTrafficCommunityDeviation)
* [User Geolocation Logon Pattern Analysis](https://d3fend.mitre.org/techniques/d3f:UserGeolocationLogonPatternAnalysis)
* [Inbound Traffic Filtering](https://d3fend.mitre.org/techniques/d3f:InboundTrafficFiltering)
* [Client-server Payload Profiling](https://d3fend.mitre.org/techniques/d3f:Client-serverPayloadProfiling)
* [Outbound Traffic Filtering](https://d3fend.mitre.org/techniques/d3f:OutboundTrafficFiltering)

## Technical Controls (Detection Rules)
### [Sigma rules public repository](https://github.com/SigmaHQ/sigma)
**Last accessed:** May 19, 2022

**Total ATT&CK-mapped rules:** 2356

**ATT&CK-mapped resources for this (sub)technique:** 6

Resources mapped to this (sub)technique can be located in the following files within the repository's <code>[rules](https://github.com/SigmaHQ/sigma/tree/master/rules)</code> folder:

* [network](https://github.com/SigmaHQ/sigma/tree/master/rules/network/) / [zeek](https://github.com/SigmaHQ/sigma/tree/master/rules/network/zeek/) / **[Potential PetitPotam Attack Via EFS RPC Calls](https://github.com/SigmaHQ/sigma/blob/master/rules/network/zeek/zeek_dce_rpc_potential_petit_potam_efs_rpc_call.yml)**
* [windows](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/) / [builtin](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/builtin/) / [security](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/builtin/security/) / **[RottenPotato Like Attack Pattern](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/security/win_susp_rottenpotato.yml)**
* [windows](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/) / [driver_load](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/driver_load/) / **[WinDivert Driver Load](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/driver_load/driver_load_windivert.yml)**
* [windows](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/) / [process_creation](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/process_creation/) / **[ADCSPwn Hack Tool](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_hack_adcspwn.yml)**
* [windows](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/) / [process_creation](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/process_creation/) / **[Impacket Tool Execution](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_impacket_compiled_tools.yml)**
* [windows](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/) / [process_creation](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/process_creation/) / **[SMB Relay Attack Tools](https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_tools_relay_attacks.yml)**


## Offensive Security Tests
### [Atomic Red Team](https://github.com/redcanaryco/atomic-red-team)
**Last accessed:** May 16, 2022

**Total ATT&CK-mapped tests:** 1258

**ATT&CK-mapped resources for this (sub)technique:** 2

The following unit tests mapped to this (sub)technique can be located in the file [here](https://github.com/redcanaryco/atomic-red-team/tree/master/atomics/T1557.001/T1557.001.yaml):

* LLMNR Poisoning with Inveigh (PowerShell)
* LLMNR Poisoning with Inveigh (PowerShell)

